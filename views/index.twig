{% extends 'layout.twig' %}

{% block body %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  
  body {
    background-color: #f8fafc;
    color: #1e293b;
    font-family: 'Inter', sans-serif;
  }

  .card-premium {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    border-radius: 12px;
  }

  .input-clean {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    font-size: 11px;
    transition: all 0.15s ease;
  }

  .input-clean:focus {
    background: #ffffff;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    outline: none;
  }

  .btn-primary {
    background: #1e293b;
    color: #ffffff;
    transition: all 0.2s;
  }

  .btn-primary:hover {
    background: #0f172a;
    transform: translateY(-1px);
  }

  .custom-scrollbar::-webkit-scrollbar { width: 5px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>

<div class="max-w-[1400px] mx-auto p-4 md:p-6 space-y-6">
  
  <!-- Global Toolbar -->
  <div class="card-premium p-4 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-bold text-lg">W</div>
      <div>
        <h1 class="text-sm font-bold text-slate-900 tracking-tight">WTOS Admin Console</h1>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Server Operational</span>
        </div>
      </div>
    </div>

    <!-- Active Context -->
    <div class="flex items-center bg-slate-50 border border-slate-200 rounded-lg p-1.5 gap-4">
       <div class="flex flex-col px-2 border-r border-slate-200">
          <label class="text-[9px] font-bold text-slate-400 uppercase">Student</label>
          <input type="text" id="_studentId" class="w-16 bg-transparent border-none p-0 text-xs font-bold text-slate-800 focus:ring-0" value="1">
       </div>
       <div class="flex flex-col px-2 border-r border-slate-200">
          <label class="text-[9px] font-bold text-slate-400 uppercase">Hostname</label>
          <input type="text" id="_api_hostname" class="w-28 bg-transparent border-none p-0 text-xs font-bold text-slate-800 focus:ring-0">
       </div>
        <div class="flex gap-4 px-3">
           <div class="text-center">
              <span class="text-[9px] font-bold text-slate-400 uppercase block">Sockets</span>
              <span class="text-[11px] font-mono text-indigo-600 font-bold" id="stat-sockets">0</span>
           </div>
           <div class="text-center">
              <span class="text-[9px] font-bold text-slate-400 uppercase block">Queue</span>
              <span class="text-[11px] font-mono text-indigo-600 font-bold" id="stat-queue">0</span>
           </div>

           <div class="text-center">
              <span class="text-[9px] font-bold text-slate-400 uppercase block">CPU</span>
              <span class="text-[11px] font-mono text-amber-600 font-bold" id="stat-cpu">0%</span>
           </div>
            <div class="text-center">
               <span class="text-[9px] font-bold text-slate-400 uppercase block">Throughput</span>
               <span class="text-[11px] font-mono text-cyan-600 font-bold" id="stat-tps">0/s</span>
            </div>

            <div class="text-center">
               <span class="text-[9px] font-bold text-slate-400 uppercase block">Memory</span>
              <span class="text-[11px] font-mono text-rose-600 font-bold" id="stat-mem">0</span>
           </div>
        </div>
    </div>
  </div>

  <!-- Row 1: Real-time Socket -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">
    
    <!-- Socket Form -->
    <div class="lg:col-span-3 card-premium overflow-hidden h-full">
      <div class="px-4 py-2.5 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
        <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Socket Emitter</h2>
        <span class="text-[9px] bg-emerald-100 text-emerald-700 font-bold px-2 py-0.5 rounded">Real-time</span>
      </div>
      <div class="p-4 space-y-3">
         <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
               <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Exam ID</label>
               <input type="text" id="_examId" placeholder="ID" class="input-clean w-full px-2.5 py-1.5 rounded-md" value="1">
            </div>
            <div class="space-y-1">
               <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Group ID</label>
               <input type="text" id="_exam_group_id" placeholder="ID" class="input-clean w-full px-2.5 py-1.5 rounded-md" value="1">
            </div>
         </div>
         <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
               <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Details ID</label>
               <input type="text" id="_examdetailsId" placeholder="ID" class="input-clean w-full px-2.5 py-1.5 rounded-md" value="1">
            </div>
            <div class="space-y-1">
               <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">History</label>
               <input type="text" id="_historyId" placeholder="ID" class="input-clean w-full px-2.5 py-1.5 rounded-md" value="1">
            </div>
         </div>
         <div class="flex gap-3">
            <div class="flex-1 space-y-1">
               <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Question</label>
               <input type="text" id="_questionId" placeholder="No" class="input-clean w-full px-2.5 py-1.5 rounded-md" value="1">
            </div>
            <div class="w-16 space-y-1">
               <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ans</label>
               <input type="text" id="_answer" placeholder="-" class="input-clean w-full px-2.5 py-1.5 rounded-md text-center font-bold text-indigo-600" value="A">
            </div>
         </div>
         <button onclick="save_text_answer()" class="btn-primary w-full py-2 mt-1 rounded-md text-[11px] font-bold shadow-sm">
            Emit Answer
         </button>
      </div>
    </div>

    <!-- Live Logs -->
    <div class="lg:col-span-9 card-premium flex flex-col h-[280px] overflow-hidden h-full">
      <div class="px-4 py-2 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
         <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest text-[#000]">Socket Stream</h2>
         <button onclick="document.getElementById('console_log').innerHTML=''" class="text-[9px] font-bold text-slate-300 hover:text-slate-500">CLEAR</button>
      </div>
      <div id="console_log" class="flex-1 overflow-y-auto p-4 font-mono text-[10px] space-y-1.5 custom-scrollbar bg-slate-50/50">
        <!-- Logs -->
      </div>
    </div>

  </div>



  <!-- Row 3: Live Monitoring Chart -->
  <div class="card-premium p-6 overflow-hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Real-time Resource Monitor</h2>
      <div class="flex gap-4">
        <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-indigo-500"></span><span class="text-[10px] text-slate-400 font-bold uppercase">Queue</span></div>

        <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-amber-500"></span><span class="text-[10px] text-slate-400 font-bold uppercase">CPU %</span></div>
        <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-rose-500"></span><span class="text-[10px] text-slate-400 font-bold uppercase">Mem</span></div>
      </div>
    </div>
    <div class="h-[180px] w-full">
      <canvas id="statsChart"></canvas>
    </div>
  </div>

</div>

<script>
  // Log formatting
  const LOG_STYLE = {
    'in': { color: 'text-indigo-600', label: 'IN' },
    'out': { color: 'text-emerald-600', label: 'OUT' },
    'sys': { color: 'text-slate-400', label: 'SYS' }
  };

  function handle_log(msg, type='in'){
      const style = LOG_STYLE[type] || LOG_STYLE.sys;
      const now = new Date().toLocaleTimeString('en-US', { hour12: false });
      
      const el = document.createElement('div');
      el.className = `flex gap-2 group border-l-2 border-transparent hover:border-indigo-100 px-1 py-0.5`;
      el.innerHTML = `
        <span class="text-[9px] text-slate-300 font-medium select-none w-14 shrink-0">${now}</span>
        <span class="text-[9px] font-bold ${style.color} w-6 select-none">${style.label}</span>
        <span class="text-slate-700 break-all select-all">${msg}</span>
      `;

      const container = document.querySelector("#console_log");
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
  }

  // Poll Stats
  const MAX_DATA_POINTS = 30;
  const ctx = document.getElementById('statsChart').getContext('2d');
  const statsChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: Array(MAX_DATA_POINTS).fill(''),
          datasets: [
              { label: 'Queue', borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', data: Array(MAX_DATA_POINTS).fill(0), borderWidth: 2, tension: 0, pointRadius: 0, fill: true },

              { label: 'CPU %', borderColor: '#f59e0b', backgroundColor: 'transparent', data: Array(MAX_DATA_POINTS).fill(0), borderWidth: 2, tension: 0, pointRadius: 0 },
              { label: 'Memory', borderColor: '#e11d48', backgroundColor: 'transparent', data: Array(MAX_DATA_POINTS).fill(0), borderWidth: 2, tension: 0.4, pointRadius: 0 }
          ]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
              legend: { display: false },
              tooltip: {
                  enabled: true,
                  mode: 'index',
                  intersect: false,
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  titleColor: '#1e293b',
                  bodyColor: '#1e293b',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 10,
                  displayColors: true,
                  callbacks: {
                      label: function(context) {
                          return context.dataset.label + ': ' + context.parsed.y + (context.dataset.label === 'Memory' ? 'MB' : '');
                      }
                  }
              }
          },
          scales: {
              x: { 
                  display: true,
                  grid: { display: false },
                  ticks: { 
                      font: { size: 8 }, 
                      color: '#94a3b8',
                      maxRotation: 0,
                      autoSkip: true,
                      maxTicksLimit: 20
                  }
              },
              y: { 
                  beginAtZero: true,
                  grid: { color: '#f1f5f9' },
                  ticks: { font: { size: 9 }, color: '#94a3b8' }
              }
          },
          animation: { duration: 0 }
      }
  });

  async function updateStats() {
      try {
          const res = await fetch('/stats');
          const data = await res.json();
          const now = new Date().toLocaleTimeString('en-US', { hour12: false, minute: '2-digit', second: '2-digit' });
          
          // Update Numbers
          document.getElementById('stat-sockets').innerText = data.sockets.connected;
          document.getElementById('stat-queue').innerText = data.queue.bufferSize;

          document.getElementById('stat-cpu').innerText = data.cpu.percentage + '%';
          document.getElementById('stat-tps').innerText = (data.queue.tps || 0) + '/s';

          document.getElementById('stat-mem').innerText = data.memory.rss + 'M';

          // Update Chart
          statsChart.data.labels.push(now);
          statsChart.data.datasets[0].data.push(data.queue.bufferSize);

          statsChart.data.datasets[2].data.push(data.cpu.percentage);
          statsChart.data.datasets[3].data.push(data.memory.rss);
          
          if (statsChart.data.labels.length > MAX_DATA_POINTS) {
              statsChart.data.labels.shift();
              statsChart.data.datasets.forEach(ds => ds.data.shift());
          }
          
          statsChart.update();
      } catch (err) {}
  }
  setInterval(updateStats, 2000);
  updateStats(); 

  // Initialize defaults
  document.getElementById('_api_hostname').value = window.location.hostname;

  // Socket
  const socketUrl = "{{ SOCKET_IO_URL }}" || window.location.origin;
  const socket = io(socketUrl, { path: "/io", transports: ['websocket', 'polling'] });
  
  socket.on("connect", () => handle_log(`Connection tunnel established`, "sys"));
  socket.on("disconnect", () => handle_log("Connection tunnel closed", "sys"));
  socket.on("log", (msg) => handle_log(msg, "in"));

  // Emitter
  window.save_text_answer = function(){
    const payload = {
      examId: document.getElementById("_examId").value,
      exam_group_id: document.getElementById("_exam_group_id").value,
      examdetailsId: document.getElementById("_examdetailsId").value,
      studentId: document.getElementById("_studentId").value,
      questionId: document.getElementById("_questionId").value,
      historyId: document.getElementById("_historyId").value,
      answer: document.getElementById("_answer").value,
    };
    socket.emit("answer_by_student", payload);
    handle_log(`Emit Answer [Q${payload.questionId}]`, "out");
  }


</script>
{% endblock %}
