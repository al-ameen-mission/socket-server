{% extends 'layout.twig' %}

{% block body %}

<div class="max-w-7xl mx-auto p-4 md:p-6 font-inter space-y-8">
  
  <!-- Header & Stats -->
  <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
    <div>
      <h3 class="text-xl font-bold text-slate-800 tracking-tight">WTOS Console</h3>
      <p class="text-xs text-slate-500">Real-time Examination Monitor</p>
    </div>
    
    <div class="flex gap-4 bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm text-xs">
         <div class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
            <span class="text-slate-400 font-semibold">Q:</span>
            <span class="font-bold text-slate-800" id="stat-queue">0</span>
         </div>
         <div class="w-px h-auto bg-slate-100"></div>
         <div class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>
             <span class="text-slate-400 font-semibold">DB:</span>
            <span class="font-bold text-slate-800" id="stat-db">0</span>
         </div>
         <div class="w-px h-auto bg-slate-100"></div>
         <div class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>
             <span class="text-slate-400 font-semibold">MEM:</span>
            <span class="font-bold text-slate-800" id="stat-mem">0</span>
         </div>
    </div>
  </div>

  <!-- SECTION 1: Socket Protocol -->
  <div class="space-y-3">
    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-1">Section 1: Real-time Socket Protocol</h4>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      
      <!-- Left: Socket Input -->
      <div class="lg:col-span-4">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-full">
          <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex items-center justify-between">
              <h5 class="text-xs font-bold text-slate-700 uppercase tracking-widest">Socket Event Emitter</h5>
              <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          </div>
          <div class="p-4 space-y-3">
              <div class="grid grid-cols-2 gap-3">
                  <div>
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Student</label>
                     <input type="text" id="_studentId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="1">
                  </div>
                   <div>
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">History</label>
                     <input type="text" id="_historyId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="1">
                  </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                   <div>
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Exam ID</label>
                     <input type="text" id="_examId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="1">
                  </div>
                   <div>
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Group ID</label>
                     <input type="text" id="_exam_group_id" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="1">
                  </div>
              </div>
               <div>
                 <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Details ID</label>
                 <input type="text" id="_examdetailsId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="1">
              </div>
               <div class="grid grid-cols-3 gap-3">
                   <div class="col-span-2">
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Question ID</label>
                     <input type="text" id="_questionId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="1">
                  </div>
                   <div>
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Ans</label>
                     <input type="text" id="_answer" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="A">
                  </div>
              </div>
              <button onclick="save_text_answer()" class="w-full mt-2 bg-slate-800 hover:bg-black text-white text-xs font-bold py-2.5 rounded transition-all shadow-sm active:scale-[0.98]">
                  Emit Payload
              </button>
          </div>
        </div>
      </div>

      <!-- Right: Live Logs -->
      <div class="lg:col-span-8">
         <div class="bg-slate-900 rounded-xl shadow-lg border border-slate-800 flex flex-col h-[320px] overflow-hidden">
             <div class="px-4 py-2 border-b border-slate-800 bg-slate-900 flex justify-between items-center">
               <div class="flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                   <h5 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Live Terminal</h5>
               </div>
               <div class="text-[10px] font-mono text-slate-600">socket.io</div>
             </div>
             
             <div id="console_log" class="flex-1 overflow-y-auto p-4 space-y-1 font-mono text-[10px] text-slate-300 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
                <!-- Logs -->
             </div>
         </div>
      </div>

    </div>
  </div>

  <!-- SECTION 2: API Protocol -->
  <div class="space-y-3">
    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-1">Section 2: REST API Protocol</h4>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- Left: API Input -->
      <div class="lg:col-span-4">
         <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-full">
           <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex items-center justify-between">
              <h5 class="text-xs font-bold text-slate-700 uppercase tracking-widest">HTTP Request</h5>
              <div class="text-[10px] font-mono text-slate-400">POST</div>
          </div>
           <div class="p-4 space-y-3">
               <div>
                  <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Hostname <span class="text-red-500">*</span></label>
                  <input type="text" id="_api_hostname" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-green-500 focus:border-green-500 outline-none transition-all" value="localhost">
               </div>
                <div class="grid grid-cols-2 gap-3">
                   <div>
                      <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Filter Exam</label>
                      <input type="text" id="_api_examId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-green-500 focus:border-green-500 outline-none transition-all" placeholder="Optional">
                   </div>
                   <div>
                      <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Filter Group</label>
                      <input type="text" id="_api_examGroupId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-green-500 focus:border-green-500 outline-none transition-all" placeholder="Optional">
                   </div>
               </div>
               <div>
                  <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Filter Details (a,b,c)</label>
                   <input type="text" id="_api_examDetailsId" class="w-full px-3 py-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-green-500 focus:border-green-500 outline-none transition-all" placeholder="Optional">
               </div>
               
               <button onclick="test_api()" class="w-full mt-2 bg-white hover:bg-green-50 text-slate-700 border border-slate-300 hover:border-green-300 text-xs font-bold py-2.5 rounded transition-all shadow-sm flex items-center justify-center gap-2 active:scale-[0.98]">
                   Fetch Records
               </button>
           </div>
         </div>
      </div>

      <!-- Right: API Results -->
      <div class="lg:col-span-8">
         <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[320px] overflow-hidden">
             <div class="px-4 py-2 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
               <h5 class="text-xs font-bold text-slate-700 uppercase tracking-widest">HTTP Response Body</h5>
               <span class="text-[10px] font-bold text-slate-400 bg-slate-200 px-2 py-0.5 rounded-full" id="result-status">Ready</span>
             </div>
             
             <div class="flex-1 overflow-auto bg-slate-50/50 p-0" id="api_results_container">
                  <!-- Empty State -->
                  <div class="h-full flex flex-col items-center justify-center text-slate-300">
                      <svg class="w-12 h-12 mb-3 opacity-25" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
                      <span class="text-xs font-medium">No Data Fetched</span>
                  </div>
             </div>
         </div>
      </div>

    </div>
  </div>

</div>

<script>
  // Log Helper
  function handle_log(msg, type='in'){
      const now = new Date().toLocaleTimeString();
      const colorClass = type === 'in' ? 'text-emerald-400' : 'text-blue-400'; 
      const arrow = type === 'in' ? '←' : '→';
      
      const el = document.createElement('div');
      el.className = `flex gap-2 items-start opacity-90`;
      el.innerHTML = `
        <span class="text-slate-600 shrink-0 font-light pt-[1px] opacity-75">${now}</span>
        <span class="${colorClass} font-bold">${arrow}</span>
        <span class="break-all whitespace-pre-wrap">${msg}</span>
      `;

      const container = document.querySelector("#console_log");
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
  }

  // Polling
  async function updateStats() {
      try {
          const res = await fetch('/stats');
          const data = await res.json();
          document.getElementById('stat-queue').innerText = data.queue.bufferSize;
          document.getElementById('stat-db').innerText = data.database.openConnections;
          document.getElementById('stat-mem').innerText = data.memory.rss;
      } catch (err) {}
  }
  setInterval(updateStats, 2000);
  updateStats(); 

  // Socket
  const socketUrl = "{{ SOCKET_IO_URL }}" || window.location.origin;
  const socket = io(socketUrl, { path: "/io", transports: ['websocket', 'polling'] });
  
  socket.on("connect", () => handle_log(`Connected (${socket.id})`, "in"));
  socket.on("disconnect", () => handle_log("Disconnected", "in"));
  socket.on("log", (msg) => handle_log(msg, "in"));

  // Save Answer
  window.save_text_answer = function(){
    const payload = {
      examId: document.querySelector("#_examId").value,
      exam_group_id: document.querySelector("#_exam_group_id").value,
      examdetailsId: document.querySelector("#_examdetailsId").value,
      studentId: document.querySelector("#_studentId").value,
      questionId: document.querySelector("#_questionId").value,
      historyId: document.querySelector("#_historyId").value,
      answer: document.querySelector("#_answer").value,
    };
    socket.emit("answer_by_student", payload);
    handle_log(`Emit: Q${payload.questionId} = ${payload.answer}`, "out");
  }

  // API Test
  window.test_api = async function() {
      const studentId = document.querySelector("#_studentId").value;
      const hostname = document.querySelector("#_api_hostname").value;
      const examId = document.querySelector("#_api_examId").value;
      const examGroupId = document.querySelector("#_api_examGroupId").value;
      const examDetailsRaw = document.querySelector("#_api_examDetailsId").value;
      
      const payload = { hostname };
      if (examId) payload.examId = examId;
      if (examGroupId) payload.examGroupId = examGroupId;
      if (examDetailsRaw) payload.examDetailsId = examDetailsRaw.split(',').map(s => s.trim());

      handle_log(`FETCH /answers/${studentId}`, "out");
      
      const resultsContainer = document.getElementById('api_results_container');
      const statusLabel = document.getElementById('result-status');
      
      resultsContainer.classList.add('opacity-50'); 
      statusLabel.innerText = "Fetching...";
      statusLabel.className = "text-[10px] font-bold text-blue-500 bg-blue-100 px-2 py-0.5 rounded-full";

      try {
          const res = await fetch(`/answers/${studentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          
          const data = await res.json();
          resultsContainer.classList.remove('opacity-50');

          if (res.ok) {
              const records = data;
              const count = records.length;
              handle_log(`Success: ${count} records`, "in");
              statusLabel.innerText = `${count} Records`;
              statusLabel.className = "text-[10px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full";
              
              if (count === 0) {
                 resultsContainer.innerHTML = `<div class="h-full flex items-center justify-center text-slate-400 text-xs">No records found.</div>`;
                 return;
              }

              // Render Table for all fields
              let html = `
                <table class="w-full text-left text-[10px] border-collapse bg-white">
                  <thead class="bg-slate-50 sticky top-0 border-b border-slate-200">
                    <tr>
                      <th class="p-2 font-bold text-slate-400 uppercase">QID</th>
                      <th class="p-2 font-bold text-slate-400 uppercase">Answer</th>
                      <th class="p-2 font-bold text-slate-400 uppercase">Exam</th>
                      <th class="p-2 font-bold text-slate-400 uppercase">Group</th>
                      <th class="p-2 font-bold text-slate-400 uppercase">Details</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">`;
              
              records.forEach(r => {
                  html += `
                    <tr class="hover:bg-slate-50 transition-colors">
                      <td class="p-2 font-bold text-slate-700">Q${r.questionId}</td>
                      <td class="p-2"><span class="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded font-bold">${r.answer}</span></td>
                      <td class="p-2 text-slate-500 font-mono">${r.examId}</td>
                      <td class="p-2 text-slate-500 font-mono">${r.examGroupId}</td>
                      <td class="p-2 text-slate-400 font-mono truncate max-w-[100px]" title="${r.examDetailsId}">${r.examDetailsId}</td>
                    </tr>
                  `;
              });
              
              html += `</tbody></table>`;
              resultsContainer.innerHTML = html;

          } else {
              handle_log(`Error: ${data.error}`, "in");
              statusLabel.innerText = "Error";
              statusLabel.className = "text-[10px] font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded-full";
              resultsContainer.innerHTML = `<div class="p-4 text-red-500 text-xs font-mono bg-red-50 border-l-2 border-red-500 m-4">${data.error}</div>`;
          }
      } catch (e) {
          resultsContainer.classList.remove('opacity-50');
          handle_log(`Net Error`, "in");
          statusLabel.innerText = "Net Error";
          statusLabel.className = "text-[10px] font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded-full";
          resultsContainer.innerHTML = `<div class="p-4 text-red-500 text-xs font-mono m-4">Network Error: ${e}</div>`;
      }
  }
</script>
{% endblock %}
