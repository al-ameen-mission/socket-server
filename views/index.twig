{% extends 'layout.twig' %}

{% block body %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  
  :root {
    --glass-bg: rgba(15, 23, 42, 0.6);
    --glass-border: rgba(255, 255, 255, 0.08);
    --accent-emerald: #10b981;
    --accent-indigo: #6366f1;
    --accent-rose: #f43f5e;
  }

  body {
    background: radial-gradient(circle at top left, #0f172a, #020617);
    color: #f1f5f9;
    font-family: 'Inter', sans-serif;
  }

  .glass {
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  }

  .input-field {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
  }

  .input-field:focus {
    background: rgba(255, 255, 255, 0.07);
    border-color: var(--accent-indigo);
    box-shadow: 0 0 0 1px var(--accent-indigo);
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
</style>

<div class="max-w-[1600px] mx-auto p-4 md:p-8 space-y-6">
  
  <!-- Top Bar: Identity & Global Controls -->
  <div class="flex flex-col lg:flex-row gap-6 items-start lg:items-center justify-between glass p-6 rounded-2xl">
    <div class="space-y-1">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-indigo-500/20 rounded-lg">
          <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-tight text-white">WTOS <span class="text-indigo-400">Hub</span></h1>
          <p class="text-[10px] text-slate-400 uppercase tracking-[0.2em] font-medium">Remote Proctoring Engine</p>
        </div>
      </div>
    </div>

    <!-- Global Params Sidebar-lite -->
    <div class="flex flex-wrap gap-4 items-center bg-white/5 p-3 rounded-xl border border-white/5">
       <div class="flex flex-col">
          <label class="text-[9px] font-bold text-slate-500 uppercase px-1">Active Student</label>
          <input type="text" id="_studentId" class="w-24 px-2 py-1 bg-transparent border-none text-sm font-bold text-white focus:ring-0" value="1">
       </div>
       <div class="w-px h-8 bg-white/10"></div>
       <div class="flex flex-col">
          <label class="text-[9px] font-bold text-slate-500 uppercase px-1">API Hostname</label>
          <input type="text" id="_api_hostname" class="w-32 px-2 py-1 bg-transparent border-none text-sm font-bold text-white focus:ring-0" value="localhost">
       </div>
       <div class="w-px h-8 bg-white/10"></div>
       <div class="flex gap-6 px-2">
           <div class="text-center">
              <div class="text-[9px] font-bold text-slate-500 uppercase">Queue</div>
              <div class="text-xs font-mono text-emerald-400 font-bold" id="stat-queue">0</div>
           </div>
           <div class="text-center">
              <div class="text-[9px] font-bold text-slate-500 uppercase">Pool</div>
              <div class="text-xs font-mono text-indigo-400 font-bold" id="stat-db">0</div>
           </div>
           <div class="text-center">
              <div class="text-[9px] font-bold text-slate-500 uppercase">RSS</div>
              <div class="text-xs font-mono text-amber-400 font-bold" id="stat-mem">0</div>
           </div>
       </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    
    <!-- Protocols Sidebar -->
    <div class="lg:col-span-4 space-y-6">
      
      <!-- Card: Socket -->
      <div class="glass rounded-2xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/5 flex items-center justify-between">
           <div class="flex items-center gap-2">
             <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)] animate-pulse"></div>
             <h3 class="text-xs font-bold text-slate-300 uppercase tracking-widest">Socket Emitter</h3>
           </div>
           <span class="text-[9px] text-slate-500 font-mono">v4.x</span>
        </div>
        <div class="p-5 space-y-4">
           <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Exam ID</label>
                <input type="text" id="_examId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white outline-none" value="1">
              </div>
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Group ID</label>
                <input type="text" id="_exam_group_id" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white outline-none" value="1">
              </div>
           </div>
           <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Details ID</label>
                <input type="text" id="_examdetailsId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white outline-none" value="1">
              </div>
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">History ID</label>
                <input type="text" id="_historyId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white outline-none" value="1">
              </div>
           </div>
           <div class="grid grid-cols-3 gap-4">
              <div class="col-span-2 space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Question ID</label>
                <input type="text" id="_questionId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white outline-none" value="1">
              </div>
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Ans</label>
                <input type="text" id="_answer" class="input-field w-full px-3 py-2 rounded-lg text-xs font-bold text-center text-emerald-400 outline-none" value="A">
              </div>
           </div>
           <button onclick="save_text_answer()" class="group w-full py-3 bg-white hover:bg-white/90 text-slate-900 text-[11px] font-bold rounded-xl transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
              Emit Event
              <svg class="w-3 h-3 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
           </button>
        </div>
      </div>

      <!-- Card: REST API -->
      <div class="glass rounded-2xl overflow-hidden border-indigo-500/10 border shadow-[0_0_20px_rgba(99,102,241,0.05)]">
        <div class="px-5 py-4 border-b border-white/5 flex items-center justify-between">
           <div class="flex items-center gap-2">
             <div class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.5)]"></div>
             <h3 class="text-xs font-bold text-slate-300 uppercase tracking-widest">REST Inspector</h3>
           </div>
           <span class="text-[9px] text-indigo-400 font-bold px-2 py-0.5 bg-indigo-500/10 rounded">POST</span>
        </div>
        <div class="p-5 space-y-4">
           <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Filter Exam</label>
                <input type="text" id="_api_examId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white placeholder-slate-700 outline-none" placeholder="-">
              </div>
              <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-semibold ml-1">Filter Group</label>
                <input type="text" id="_api_examGroupId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white placeholder-slate-700 outline-none" placeholder="-">
              </div>
           </div>
           <div class="space-y-1">
             <label class="text-[10px] text-slate-500 font-semibold ml-1">Details Context (CSV)</label>
             <input type="text" id="_api_examDetailsId" class="input-field w-full px-3 py-2 rounded-lg text-xs font-mono text-white placeholder-slate-700 outline-none" placeholder="e.g. 101, 102">
           </div>
           <button onclick="test_api()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white text-[11px] font-bold rounded-xl transition-all shadow-lg shadow-indigo-600/20 active:scale-[0.98]">
              Fetch Answers
           </button>
        </div>
      </div>

    </div>

    <!-- Main Console Output -->
    <div class="lg:col-span-8 space-y-6">
      
      <!-- API Results Table -->
      <div class="glass rounded-2xl flex flex-col h-[400px] overflow-hidden">
        <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/2">
           <div class="flex items-center gap-3">
             <h5 class="text-sm font-semibold text-white tracking-wide">Structured Data</h5>
             <span id="result-status" class="text-[9px] font-bold bg-white/5 text-slate-400 px-2 py-1 rounded-md border border-white/5 uppercase tracking-tighter">Standby</span>
           </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar" id="api_results_container">
          <!-- Empty State -->
          <div class="h-full flex flex-col items-center justify-center opacity-40">
             <div class="p-4 bg-white/5 rounded-full mb-4">
               <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
             </div>
             <p class="text-xs font-medium text-slate-500">Awaiting REST response...</p>
          </div>
        </div>
      </div>

      <!-- Logs -->
      <div class="glass rounded-2xl flex flex-col h-[320px] overflow-hidden border border-emerald-500/5">
        <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-slate-900/40">
           <div class="flex items-center gap-3">
             <h5 class="text-sm font-semibold text-white tracking-wide">Live Stream</h5>
             <div class="flex items-center gap-1.5 px-2 py-1 bg-emerald-500/10 rounded-md border border-emerald-500/10">
               <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
               <span class="text-[9px] font-bold text-emerald-400 uppercase tracking-tighter">Real-time</span>
             </div>
           </div>
           <button onclick="document.getElementById('console_log').innerHTML=''" class="text-[10px] font-bold text-slate-500 hover:text-rose-400 transition-colors">CLEAR</button>
        </div>
        <div id="console_log" class="flex-1 overflow-y-auto p-6 font-mono text-[11px] space-y-1.5 custom-scrollbar leading-relaxed">
           <!-- Logs -->
        </div>
      </div>

    </div>
  </div>

</div>

<script>
  // Advanced Log Color Matrix
  const LOG_STYLE = {
    'in': { color: 'text-emerald-400', arrow: '→', bg: 'bg-emerald-500/5' },
    'out': { color: 'text-indigo-400', arrow: '←', bg: 'bg-indigo-500/5' },
    'sys': { color: 'text-amber-400', arrow: '⚡', bg: '' }
  };

  function handle_log(msg, type='in'){
      const style = LOG_STYLE[type] || LOG_STYLE.sys;
      const now = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 1 });
      
      const el = document.createElement('div');
      el.className = `flex gap-3 items-start p-1.5 rounded transition-colors hover:bg-white/5 group`;
      el.innerHTML = `
        <span class="text-slate-600 shrink-0 font-medium opacity-50 select-none">${now}</span>
        <span class="${style.color} font-bold select-none">${style.arrow}</span>
        <span class="text-slate-200 break-all whitespace-pre-wrap">${msg}</span>
      `;

      const container = document.querySelector("#console_log");
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
  }

  async function updateStats() {
      try {
          const res = await fetch('/stats');
          const data = await res.json();
          document.getElementById('stat-queue').innerText = data.queue.bufferSize;
          document.getElementById('stat-db').innerText = data.database.openConnections;
          document.getElementById('stat-mem').innerText = data.memory.rss + 'M';
      } catch (err) {}
  }
  setInterval(updateStats, 2000);
  updateStats(); 

  const socketUrl = "{{ SOCKET_IO_URL }}" || window.location.origin;
  const socket = io(socketUrl, { path: "/io", transports: ['websocket', 'polling'] });
  
  socket.on("connect", () => handle_log(`Node established: ${socket.id}`, "sys"));
  socket.on("disconnect", () => handle_log("Node connection lost", "sys"));
  socket.on("log", (msg) => handle_log(msg, "in"));

  window.save_text_answer = function(){
    const payload = {
      examId: document.getElementById("_examId").value,
      exam_group_id: document.getElementById("_exam_group_id").value,
      examdetailsId: document.getElementById("_examdetailsId").value,
      studentId: document.getElementById("_studentId").value,
      questionId: document.getElementById("_questionId").value,
      historyId: document.getElementById("_historyId").value,
      answer: document.getElementById("_answer").value,
    };
    socket.emit("answer_by_student", payload);
    handle_log(`Emit [Q${payload.questionId}]: Payload processed locally`, "out");
  }

  window.test_api = async function() {
      const studentId = document.getElementById("_studentId").value;
      const hostname = document.getElementById("_api_hostname").value;
      const examId = document.getElementById("_api_examId").value;
      const examGroupId = document.getElementById("_api_examGroupId").value;
      const examDetailsRaw = document.getElementById("_api_examDetailsId").value;
      
      const payload = { hostname };
      if (examId) payload.examId = examId;
      if (examGroupId) payload.examGroupId = examGroupId;
      if (examDetailsRaw) payload.examDetailsId = examDetailsRaw.split(',').map(s => s.trim());

      handle_log(`POST /answers/${studentId}`, "out");
      
      const resultsContainer = document.getElementById('api_results_container');
      const statusLabel = document.getElementById('result-status');
      
      resultsContainer.classList.add('opacity-40'); 
      statusLabel.innerText = "PENDING";
      statusLabel.className = "text-[9px] font-bold bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-md border border-indigo-500/20 uppercase tracking-tighter";

      try {
          const res = await fetch(`/answers/${studentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          
          const records = await res.json();
          resultsContainer.classList.remove('opacity-40');

          if (res.ok) {
              const count = records.length;
              handle_log(`API Response: ${count} records`, "in");
              statusLabel.innerText = `${count} OBJECTS`;
              statusLabel.className = "text-[9px] font-bold bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-md border border-emerald-500/20 uppercase tracking-tighter";
              
              if (count === 0) {
                 resultsContainer.innerHTML = `<div class="h-full flex items-center justify-center text-slate-500 text-xs font-medium">Empty set returned for filter profile</div>`;
                 return;
              }

              let html = `
                <table class="w-full text-left border-collapse">
                  <thead class="sticky top-0 bg-slate-900 border-b border-white/10 z-10">
                    <tr>
                      <th class="p-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Question</th>
                      <th class="p-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">Value</th>
                      <th class="p-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Metadata Context</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-white/5">`;
              
              records.forEach(r => {
                  html += `
                    <tr class="hover:bg-white/[0.02] transition-colors group">
                      <td class="p-4">
                        <div class="flex flex-col">
                           <span class="text-xs font-bold text-white group-hover:text-indigo-400 transition-colors">Q${r.questionId}</span>
                           <span class="text-[9px] text-slate-500 font-mono">ID: ${r.studentId}</span>
                        </div>
                      </td>
                      <td class="p-4 text-center">
                         <span class="inline-block min-w-[24px] bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded px-2 py-0.5 text-xs font-bold">${r.answer}</span>
                      </td>
                      <td class="p-4">
                        <div class="flex items-center gap-3">
                           <div class="space-y-0.5">
                              <span class="block text-[10px] text-slate-300 font-mono"><span class="text-slate-600">EXAM:</span> ${r.examId}</span>
                              <span class="block text-[10px] text-slate-300 font-mono"><span class="text-slate-600">GRP:</span> ${r.examGroupId}</span>
                           </div>
                           <div class="h-6 w-px bg-white/5"></div>
                           <span class="text-[9px] text-slate-500 font-mono truncate max-w-[150px]" title="${r.examDetailsId}">${r.examDetailsId}</span>
                        </div>
                      </td>
                    </tr>
                  `;
              });
              
              html += `</tbody></table>`;
              resultsContainer.innerHTML = html;

          } else {
              handle_log(`Service error: ${records.error}`, "sys");
              statusLabel.innerText = "FAILED";
              statusLabel.className = "text-[9px] font-bold bg-rose-500/20 text-rose-400 px-2 py-1 rounded-md border border-rose-500/20 uppercase tracking-tighter";
              resultsContainer.innerHTML = `<div class="p-6 text-rose-400 text-xs font-mono bg-rose-500/5 m-6 rounded-xl border border-rose-500/20">${records.error}</div>`;
          }
      } catch (e) {
          resultsContainer.classList.remove('opacity-40');
          handle_log(`Connection refused`, "sys");
          statusLabel.innerText = "OFFLINE";
          statusLabel.className = "text-[9px] font-bold bg-rose-500/20 text-rose-400 px-2 py-1 rounded-md border border-rose-500/20 uppercase tracking-tighter";
          resultsContainer.innerHTML = `<div class="p-6 text-rose-400 text-xs font-mono m-6 rounded-xl border border-rose-500/20">${e}</div>`;
      }
  }
</script>
{% endblock %}

